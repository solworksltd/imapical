!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("emailjs-imap-client"),require("ical-expander")):"function"==typeof define&&define.amd?define(["emailjs-imap-client","ical-expander"],t):"object"==typeof exports?exports.imapical=t(require("emailjs-imap-client"),require("ical-expander")):e.imapical=t(e["emailjs-imap-client"],e["ical-expander"])}(this,function(e,t){return function(e){function t(r){if(n[r])return n[r].exports;var a=n[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,t),a.l=!0,a.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(1),a=function(e){return e&&e.__esModule?e:{default:e}}(r);t.default=function(e){if(!e)throw new Error("Configuration expected");return new a.default(e)}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function a(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=n(2),u=r(s),c=n(3),l=r(c),f=function(){function e(t){i(this,e),this.opts={host:t.host,port:t.port,auth:{user:t.username,pass:t.password}},this.mailboxBrowser=new u.default(this.opts.host,this.opts.port||this.opts,this.opts),this.mailboxBrowser.logLevel=this.mailboxBrowser.LOG_LEVEL_NONE,this.clients=[]}return o(e,[{key:"createMailboxClient",value:function(e){var t=this.opts;return new Promise(function(n,r){if(!e.path)return r("Mailbox must include a path");var a=new u.default(t.host,t.port||t,t);a.logLevel=a.LOG_LEVEL_NONE,a.connect().then(function(){return a.selectMailbox(e.path)}).then(function(){return a.mailbox=e.path,n(a)})})}},{key:"createMailboxClients",value:function(){var e=this;return this.listMailboxes().then(function(t){return Promise.all(t.map(function(t){return e.createMailboxClient(t)})).then(function(t){e.clients=t})})}},{key:"disconnectMailboxes",value:function(){var e=this;return Promise.all(this.clients.map(function(e){return e.close()})).then(function(){return e.mailboxBrowser.close()})}},{key:"listMailboxes",value:function(){var e=this;return this.mailboxBrowser.connect().then(function(){return e.mailboxBrowser.listMailboxes().then(function(e){return e.children})})}},{key:"findCalAttachmentInBodyStructure",value:function(e){var t=this;return e.childNodes?e.childNodes.map(function(e){return"text/calendar"===e.type?e:e.childNodes?t.findCalAttachmentInBodyStructure(e):void 0}).find(function(e){return!!e}):e.type&&"text/calendar"===e.type?e:null}},{key:"fetch",value:function(){var e=this;return this.createMailboxClients().then(function(){return e.searchUnseenMails()}).then(function(t){return e.getMessagesForSearchResults(t)}).then(function(t){return e.getBodyPartsForMessages(t)}).then(function(t){return e.getAttachmentsFromBodyParts(t)}).then(function(t){return e.disconnectMailboxes().then(function(){return Promise.all(t.map(function(t){var n=t.attachment,r=t.message,a=e.parseICAL(n);return a["message-id"]=r.envelope["message-id"],a}))})})}},{key:"getAttachmentsFromBodyParts",value:function(e){var t=this;return Promise.all(e.map(function(e){var n=e.client,r=e.messagesWithBodyParts;return Promise.all(r.map(function(e){var r=e.message,a=e.bodyParts,i=a.encoding,o=a.part;return o?t.getMessagePart(n,r,o).then(function(e){var t=e[0],n=t["body["+a.part+"]"];return n=n.replace(/\r\n/g,""),"base64"===i?{message:r,attachment:Buffer.from(n,"base64").toString()}:n}):null}))})).then(function(e){return e.reduce(function(e,t){return[].concat(a(e),a(t))},[])})}},{key:"getBodyPartsForMessages",value:function(e){var t=this;return Promise.all(e.map(function(e){return{client:e.client,messagesWithBodyParts:e.messages.map(function(e){return{message:e,bodyParts:t.findCalAttachmentInBodyStructure(e.bodystructure)}})}}))}},{key:"getMessagesForSearchResults",value:function(e){var t=this;return Promise.all(e.map(function(e){var n=e.client,r=e.searchResults;return r.length>0?t.getMessageData(n,r).then(function(e){return{client:n,messages:e}}):{client:n,messages:[]}}))}},{key:"getMessageData",value:function(e,t){return e.listMessages(e.mailbox,t.join(","),["uid","flags","envelope","bodystructure","body.peek[]"])}},{key:"getMessagePart",value:function(e,t,n){return e.listMessages(e.mailbox,t["#"],["body["+n+"]"])}},{key:"parseICAL",value:function(e){var t=new l.default({ics:e}),n=t.all(),r=n.events,a=r[0],i={};return i.attendees=a.attendees.map(function(e){return e.getFirstValue().replace("MAILTO:","")}),i.organiser=a.organizer.replace("MAILTO:",""),i.description=a.description,i.summary=a.summary,i.startDate=a.startDate.toJSDate(),i.endDate=a.endDate.toJSDate(),i}},{key:"searchUnseenMails",value:function(){return Promise.all(this.clients.map(function(e){return e.search(e.mailbox,{unseen:!0}).then(function(t){return{client:e,searchResults:t}})}))}}]),e}();t.default=f},function(t,n){t.exports=e},function(e,n){e.exports=t}]).default});
//# sourceMappingURL=index.js.map